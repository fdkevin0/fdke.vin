---
const { defaultCurrency = "USD", limit = 12 } = Astro.props;
---

<exchange-rates class="block" data-default-currency={defaultCurrency} data-limit={limit}>
	<div class="overflow-hidden rounded-2xl border border-zinc-200 shadow-sm dark:border-zinc-700">
		<div
			class="bg-gradient-to-br from-zinc-100 via-white to-zinc-50 px-5 py-6 sm:px-6 dark:from-zinc-900 dark:via-zinc-950 dark:to-zinc-900"
		>
			<div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
				<div class="space-y-1">
					<p class="text-[11px] tracking-[0.42em] text-zinc-500 uppercase dark:text-zinc-400">
						Exchange Rates · Live
					</p>
					<p class="title text-xl">FX Rates Board</p>
					<p class="text-xs text-zinc-600 dark:text-zinc-300">
						Shows the latest {limit} quotes; default currency is {defaultCurrency}.
					</p>
				</div>
				<div class="flex flex-wrap items-center gap-3 text-xs font-semibold">
					<label class="flex items-center gap-2 text-zinc-600 dark:text-zinc-200">
						<span>Currency</span>
						<select
							class="bg-global-bg hover:border-accent focus:border-accent focus:ring-accent border border-zinc-300 px-3 py-2 text-sm font-semibold transition outline-none focus:ring-1 dark:border-zinc-700"
							data-currency-select
						>
							<option value={defaultCurrency}>{defaultCurrency}</option>
						</select>
					</label>
					<button
						class="text-accent border-accent hover:bg-accent dark:hover:text-global-bg rounded-md border px-3 py-2 font-semibold transition hover:text-white disabled:cursor-not-allowed disabled:opacity-60"
						data-refresh
						type="button"
					>
						Refresh
					</button>
				</div>
			</div>
			<div class="mt-4 grid gap-3 sm:grid-cols-3">
				<div
					class="rounded-lg border border-zinc-200 bg-white/70 px-3 py-3 dark:border-zinc-700 dark:bg-zinc-900/70"
				>
					<p class="text-[11px] tracking-[0.32em] text-zinc-500 uppercase dark:text-zinc-400">
						Latest Mid
					</p>
					<p class="text-accent-2 dark:text-accent text-2xl font-semibold" data-highlight-mid>--</p>
					<p class="text-xs text-zinc-500 dark:text-zinc-300" data-highlight-time>--</p>
				</div>
				<div
					class="rounded-lg border border-zinc-200 bg-white/70 px-3 py-3 dark:border-zinc-700 dark:bg-zinc-900/70"
				>
					<p class="text-[11px] tracking-[0.32em] text-zinc-500 uppercase dark:text-zinc-400">
						Buy / Sell
					</p>
					<p class="text-accent-2 dark:text-accent text-xl font-semibold" data-highlight-buy-sell>
						--
					</p>
					<p class="text-xs text-zinc-500 dark:text-zinc-300">Cash and spot included</p>
				</div>
				<div
					class="rounded-lg border border-zinc-200 bg-white/70 px-3 py-3 dark:border-zinc-700 dark:bg-zinc-900/70"
				>
					<p class="text-[11px] tracking-[0.32em] text-zinc-500 uppercase dark:text-zinc-400">
						Latest Change
					</p>
					<p
						class="text-xl font-semibold text-emerald-600 dark:text-emerald-400"
						data-highlight-change
					>
						--
					</p>
					<p class="text-xs text-zinc-500 dark:text-zinc-300" data-highlight-compare>
						Waiting to load…
					</p>
				</div>
			</div>
		</div>
		<div class="space-y-3 px-5 pt-3 pb-6 sm:px-6">
			<div
				class="rounded-md border border-dashed border-zinc-300 px-3 py-2 text-sm text-zinc-600 dark:border-zinc-700 dark:text-zinc-300"
				data-status
				role="status"
			>
				Loading supported currencies…
			</div>
			<div class="overflow-x-auto rounded-xl border border-zinc-200 dark:border-zinc-700">
				<table class="min-w-full divide-y divide-zinc-200 dark:divide-zinc-700">
					<thead
						class="bg-zinc-100/80 text-xs tracking-wide text-zinc-600 uppercase dark:bg-zinc-900/70 dark:text-zinc-300"
					>
						<tr>
							<th class="px-4 py-3 text-left font-semibold">Time</th>
							<th class="px-4 py-3 text-right font-semibold">Buy (Spot)</th>
							<th class="px-4 py-3 text-right font-semibold">Buy (Cash)</th>
							<th class="px-4 py-3 text-right font-semibold">Sell (Spot)</th>
							<th class="px-4 py-3 text-right font-semibold">Sell (Cash)</th>
							<th class="px-4 py-3 text-right font-semibold">Mid</th>
						</tr>
					</thead>
					<tbody class="divide-y divide-zinc-200 text-sm dark:divide-zinc-800" data-table-body>
						<tr>
							<td class="px-4 py-4 text-center text-zinc-500" colspan={6}>Loading…</td>
						</tr>
					</tbody>
				</table>
			</div>
			<div
				class="flex flex-wrap items-center justify-between gap-3 text-[11px] tracking-[0.28em] text-zinc-500 uppercase dark:text-zinc-300"
			>
				<p data-meta>Waiting…</p>
				<p data-pagination>--</p>
			</div>
		</div>
	</div>
</exchange-rates>

<script>
	const currencyEndpoint = "/api/exchange/currencies?platform=boc";
	const ratesEndpoint = "/api/exchange/rates";

	type RateRow = {
		buyingRate: number;
		cashBuyingRate: number;
		cashSellingRate: number;
		currency: string;
		middleRate: number;
		pubTime: string;
		sellingRate: number;
	};

	type RatesResponse = {
		data: RateRow[];
		pagination: {
			page: number;
			pageSize: number;
			total: number;
			totalPages: number;
			hasNextPage: boolean;
		};
	};

	class ExchangeRatesElement extends HTMLElement {
		#currencySelect: HTMLSelectElement | null;
		#refreshBtn: HTMLButtonElement | null;
		#statusEl: HTMLElement | null;
		#tableBody: HTMLTableSectionElement | null;
		#metaEl: HTMLElement | null;
		#paginationEl: HTMLElement | null;
		#highlightTime: HTMLElement | null;
		#highlightMid: HTMLElement | null;
	#highlightBuySell: HTMLElement | null;
	#highlightChange: HTMLElement | null;
	#highlightCompare: HTMLElement | null;
	#limit: number;
	#storageKey = "exchange:currency";

		constructor() {
			super();
			this.#currencySelect = this.querySelector(
				"[data-currency-select]"
			) as HTMLSelectElement | null;
			this.#refreshBtn = this.querySelector("[data-refresh]") as HTMLButtonElement | null;
			this.#statusEl = this.querySelector("[data-status]");
			this.#tableBody = this.querySelector("[data-table-body]") as HTMLTableSectionElement | null;
			this.#metaEl = this.querySelector("[data-meta]");
			this.#paginationEl = this.querySelector("[data-pagination]");
			this.#highlightTime = this.querySelector("[data-highlight-time]");
			this.#highlightMid = this.querySelector("[data-highlight-mid]");
			this.#highlightBuySell = this.querySelector("[data-highlight-buy-sell]");
			this.#highlightChange = this.querySelector("[data-highlight-change]");
			this.#highlightCompare = this.querySelector("[data-highlight-compare]");
			this.#limit = Number.parseInt(this.dataset.limit || "12", 10);
			if (Number.isNaN(this.#limit) || this.#limit <= 0) this.#limit = 12;
		}

	connectedCallback() {
		this.#refreshBtn?.addEventListener("click", this.#handleRefresh);
		this.#currencySelect?.addEventListener("change", this.#handleChange);
		this.#loadCurrencies()
			.then((initialCurrency) => {
				const currency =
					initialCurrency ||
					this.#currencySelect?.value ||
					this.dataset.defaultCurrency ||
					"USD";
				this.#loadRates(currency);
			})
			.catch(() => {
				const currency = this.#currencySelect?.value || this.dataset.defaultCurrency || "USD";
				this.#loadRates(currency);
			});
	}

		disconnectedCallback() {
			this.#refreshBtn?.removeEventListener("click", this.#handleRefresh);
			this.#currencySelect?.removeEventListener("change", this.#handleChange);
		}

	#handleChange = () => {
		const currency = this.#currencySelect?.value;
		if (currency) {
			this.#saveCurrency(currency);
			this.#loadRates(currency);
		}
	};

		#handleRefresh = () => {
			this.#handleChange();
		};

	async #loadCurrencies() {
		if (!this.#statusEl) return null;
		this.#setStatus("Loading supported currencies…", false);
		let selectedCurrency = this.dataset.defaultCurrency || "USD";
		try {
			const res = await fetch(currencyEndpoint);
			if (!res.ok) throw new Error(res.statusText);
			const list: string[] = await res.json();
			if (this.#currencySelect && Array.isArray(list)) {
				this.#currencySelect.innerHTML = "";
				const defaultValue = this.dataset.defaultCurrency || "USD";
				const storedCurrency = this.#getStoredCurrency();
				list.forEach((code) => {
					const option = document.createElement("option");
					option.value = code;
					option.textContent = code;
					if (storedCurrency && code === storedCurrency) {
						option.selected = true;
						selectedCurrency = storedCurrency;
					} else if (!storedCurrency && code === defaultValue) {
						option.selected = true;
					}
					this.#currencySelect?.appendChild(option);
				});
			}
			this.#setStatus("Currencies loaded. You can switch anytime.", false);
			return selectedCurrency;
		} catch (error) {
			console.error("Failed to load currencies", error);
			this.#setStatus("Unable to load currencies. Using default.", true);
			return selectedCurrency;
		}
	}

		async #loadRates(currency: string) {
			if (!this.#statusEl || !this.#tableBody) return;
			this.#setStatus(`Fetching latest ${currency} rates…`, false);
			this.#refreshBtn?.setAttribute("disabled", "true");
			try {
				const url = `${ratesEndpoint}?platform=boc&currency=${encodeURIComponent(
					currency
				)}&limit=${this.#limit}`;
				const res = await fetch(url);
				if (!res.ok) throw new Error(res.statusText);
				const payload: RatesResponse = await res.json();
				this.#renderTable(payload.data);
				this.#renderMeta(currency, payload);
				this.#setStatus(`${currency} rates refreshed.`, false);
			} catch (error) {
				console.error("Failed to load rates", error);
				this.#setStatus("Failed to fetch rates. Please try again.", true);
			} finally {
				this.#refreshBtn?.removeAttribute("disabled");
			}
		}

		#renderTable(rows: RateRow[]) {
			if (!this.#tableBody) return;
			this.#tableBody.innerHTML = "";
			if (!rows?.length) {
				this.#tableBody.innerHTML =
					'<tr><td class="px-4 py-4 text-center text-zinc-500" colSpan="6">No data</td></tr>';
				this.#clearHighlight();
				return;
			}

			const fragment = document.createDocumentFragment();
			rows.forEach((row, index) => {
				const tr = document.createElement("tr");
				tr.className =
					index === 0
						? "bg-accent/5 dark:bg-accent/10"
						: "odd:bg-white even:bg-zinc-50 dark:odd:bg-zinc-900 dark:even:bg-zinc-950";
				tr.innerHTML = `
					<td class="px-4 py-3 font-semibold text-zinc-700 dark:text-zinc-200">${row.pubTime}</td>
					<td class="px-4 py-3 text-right tabular-nums">${this.#formatRate(row.buyingRate)}</td>
					<td class="px-4 py-3 text-right tabular-nums">${this.#formatRate(row.cashBuyingRate)}</td>
					<td class="px-4 py-3 text-right tabular-nums">${this.#formatRate(row.sellingRate)}</td>
					<td class="px-4 py-3 text-right tabular-nums">${this.#formatRate(row.cashSellingRate)}</td>
					<td class="px-4 py-3 text-right font-semibold tabular-nums">
						${this.#formatRate(row.middleRate)}
					</td>
				`;
				fragment.append(tr);
			});

			this.#tableBody.appendChild(fragment);
			this.#renderHighlight(rows);
		}

		#renderMeta(currency: string, payload: RatesResponse) {
			if (!this.#metaEl || !this.#paginationEl) return;
			const total = payload?.pagination?.total ?? payload.data.length;
			this.#metaEl.textContent = `${currency} · Showing ${payload.data.length} / ${total} latest`;
			const { page, totalPages, hasNextPage } = payload.pagination || {};
			this.#paginationEl.textContent = `Page ${page || 1} / ${totalPages || 1}${
				hasNextPage ? " · More available" : ""
			}`;
		}

		#renderHighlight(rows: RateRow[]) {
			if (!Array.isArray(rows) || rows.length === 0) {
				this.#clearHighlight();
				return;
			}
			const [latest, prev] = rows;
			if (!latest) {
				this.#clearHighlight();
				return;
			}
			const delta = prev ? latest.middleRate - prev.middleRate : 0;
			const direction = delta === 0 ? "Flat" : delta > 0 ? "Up" : "Down";
			const deltaText = delta === 0 ? "0.00" : Math.abs(delta).toFixed(2);

			if (this.#highlightMid) this.#highlightMid.textContent = this.#formatRate(latest.middleRate);
			if (this.#highlightTime) this.#highlightTime.textContent = latest.pubTime;
			if (this.#highlightBuySell) {
				this.#highlightBuySell.textContent = `${this.#formatRate(latest.buyingRate)} / ${this.#formatRate(latest.sellingRate)}`;
			}
			if (this.#highlightChange) {
				this.#highlightChange.textContent = `${direction} ${deltaText}`;
				this.#highlightChange.classList.remove(
					"text-emerald-600",
					"dark:text-emerald-400",
					"text-red-600",
					"dark:text-red-400"
				);
				const up = delta > 0;
				this.#highlightChange.classList.add(
					up ? "text-emerald-600" : "text-red-600",
					up ? "dark:text-emerald-400" : "dark:text-red-400"
				);
			}
			if (this.#highlightCompare) {
				this.#highlightCompare.textContent = prev
					? `Vs ${prev.pubTime} · Change ${deltaText}`
					: "No previous tick yet";
			}
		}

		#clearHighlight() {
			if (this.#highlightMid) this.#highlightMid.textContent = "--";
			if (this.#highlightTime) this.#highlightTime.textContent = "--";
			if (this.#highlightBuySell) this.#highlightBuySell.textContent = "--";
			if (this.#highlightChange) this.#highlightChange.textContent = "--";
			if (this.#highlightCompare) this.#highlightCompare.textContent = "Waiting for data…";
		}

		#formatRate(value: number) {
			if (value === undefined || value === null || Number.isNaN(value)) return "--";
			return new Intl.NumberFormat("en-US", {
				minimumFractionDigits: 2,
				maximumFractionDigits: 2,
			}).format(value);
		}

	#setStatus(message: string, isError: boolean) {
		if (!this.#statusEl) return;
		this.#statusEl.textContent = message;
		this.#statusEl.classList.toggle("text-red-600", isError);
		this.#statusEl.classList.toggle("dark:text-red-400", isError);
	}

	#getStoredCurrency() {
		try {
			return localStorage.getItem(this.#storageKey);
		} catch (error) {
			console.warn("Unable to read stored currency", error);
			return null;
		}
	}

	#saveCurrency(currency: string) {
		try {
			localStorage.setItem(this.#storageKey, currency);
		} catch (error) {
			console.warn("Unable to persist currency preference", error);
		}
	}
	}

	customElements.define("exchange-rates", ExchangeRatesElement);
</script>
